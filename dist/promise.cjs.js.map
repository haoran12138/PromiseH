{"version":3,"file":"promise.cjs.js","sources":["../src/core/utils.ts","../src/core/resolvePromise.ts","../src/core/myPromise.ts"],"sourcesContent":["import MyPromise from \"./myPromise\";\n\nconst toString = Object.prototype.toString\n\nexport function isPromise(v): v is MyPromise {\n  return v instanceof MyPromise\n}\n\nexport function isFunction(fn: any): fn is Function {\n  return toString.call(fn) === '[object Function]'\n}\n\nexport function isPlainObject(val: any): val is Object {\n  return toString.call(val) === '[object Object]'\n}\n\nexport function onFulfilledPromise(promise, value) {\n  if (promise.state !== 'pending') return\n  promise.state = 'fulfilled'\n  promise.result = value;\n  promise.onFulfilledFns.forEach(fn => {\n    fn(value)\n  })\n}\n\nexport function onRejectedPromise(promise, value) {\n  if (promise.state !== 'pending') return\n  promise.state = 'rejected'\n  promise.result = value;\n  promise.onRejectedFns.forEach(fn => {\n    fn(value)\n  })\n}\n\n","import {\n  isPromise,\n  isFunction,\n  isPlainObject,\n  onFulfilledPromise,\n  onRejectedPromise,\n\n} from \"./utils\";\n\n\nexport default function resolvePromise(promise, x) {\n  if (promise === x) {\n    onRejectedPromise(promise, new TypeError('Chaining cycle detected for promise'))\n    return\n  }\n  if (isPromise(x)) {\n    if (x.state === 'pending') {\n      x.then(value => {\n        resolvePromise(promise, value)\n      }, reason => {\n        onRejectedPromise(promise, reason)\n      })\n    }\n    if (x.state === 'fulfilled') {\n      onFulfilledPromise(promise, x.result)\n    }\n    if (x.state === 'rejected') {\n      onRejectedPromise(promise, x.result)\n    }\n    return;\n  }\n  if (isFunction(x) || isPlainObject(x)) {\n    let flag = false;\n    let then\n    try {\n      then = x.then\n    } catch (e) {\n      onRejectedPromise(promise, e)\n      return;\n    }\n    if (isFunction(then)) {\n      try {\n        then.call(x, y => {\n          if (flag) return\n          flag = true;\n          resolvePromise(promise, y)\n        }, r => {\n          if (flag) return\n          flag = true;\n          onRejectedPromise(promise, r)\n        })\n      } catch (e) {\n        if (flag) return\n        flag = true;\n        onRejectedPromise(promise, e)\n      }\n    } else {\n      onFulfilledPromise(promise, x)\n    }\n  } else {\n    onFulfilledPromise(promise, x)\n  }\n}\n","import { promiseState, resolver, ThenFn } from \"../type\";\nimport { isFunction, onRejectedPromise, } from \"./utils\";\nimport resolvePromise from \"./resolvePromise\";\n\nexport default class MyPromise {\n  state: promiseState = 'pending'\n  result = undefined\n  onFulfilledFns: ThenFn[] = []\n  onRejectedFns: ThenFn[] = []\n\n  static resolve(value) {\n    return new MyPromise((resolve, reject) => {\n      resolve(value)\n    })\n  }\n\n  static reject(reason) {\n    return new MyPromise((resolve, reject) => {\n      reject(reason)\n    })\n  }\n\n  constructor(fn: resolver) {\n    if (!isFunction(fn)) {\n      throw new TypeError(`Promise resolver ${ fn } is not a function`)\n    }\n    this.state = 'pending'\n    this.result = undefined\n    this.onRejectedFns = []\n    this.onFulfilledFns = [];\n    fn(value => {\n        resolvePromise(this, value)\n      },\n      reason => {\n        onRejectedPromise(this, reason)\n      })\n  }\n\n  then(onFulfilled?: ThenFn, onRejected?: ThenFn) {\n    onFulfilled = isFunction(onFulfilled) ? onFulfilled : value => value\n    onRejected = isFunction(onRejected) ? onRejected : reason => {\n      throw reason\n    }\n    let promise2\n\n    promise2 = new MyPromise(() => {\n\n      if (this.state === 'pending') {\n        this.onRejectedFns.push(() => {\n          setTimeout(() => {\n            try {\n              let x = onRejected(this.result)\n              resolvePromise(promise2, x)\n            } catch (error) {\n              onRejectedPromise(promise2, error)\n            }\n          })\n        })\n        this.onFulfilledFns.push(() => {\n          setTimeout(() => {\n            try {\n              let x = onFulfilled(this.result)\n              resolvePromise(promise2, x)\n            } catch (error) {\n              onRejectedPromise(promise2, error)\n            }\n          })\n        })\n      }\n      if (this.state === 'rejected') {\n        setTimeout(() => {\n          try {\n            let x = onRejected(this.result)\n            resolvePromise(promise2, x)\n          } catch (e) {\n            onRejectedPromise(promise2, e)\n          }\n        })\n      }\n      if (this.state === 'fulfilled') {\n        setTimeout(() => {\n          try {\n            let x = onFulfilled(this.result)\n            resolvePromise(promise2, x)\n          } catch (e) {\n            onRejectedPromise(promise2, e)\n          }\n        })\n      }\n\n    })\n\n    return promise2\n  }\n}\n"],"names":[],"mappings":"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"}