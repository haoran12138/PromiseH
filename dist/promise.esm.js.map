{"version":3,"file":"promise.esm.js","sources":["../src/core/utils.ts","../src/core/resolvePromise.ts","../src/core/myPromise.ts"],"sourcesContent":["import MyPromise from \"./myPromise\";\nimport { promiseStateItem } from \"../type\";\n\nconst toString = Object.prototype.toString\n\nexport function isPlanObject(val: any): val is Object {\n  return toString.call(val) === '[object Object]'\n}\n\nexport function isFunction(val: any): val is Function {\n  return toString.call(val) === '[object Function]'\n}\n\nexport function isMyPromise(val: any): val is MyPromise {\n  return val instanceof MyPromise\n}\n\nexport const promsieStateList: promiseStateItem = {\n  pending: 'pending',\n  fulfilled: 'fulfilled',\n  rejected: 'rejected',\n}\n\nexport function fulfilledPromise(promise: MyPromise, value: any) {\n  if (promise.state !== 'pending') return\n  promise.state = 'fulfilled'\n  promise.result = value\n  promise.onFulfilledCabs.forEach(cb => cb(value))\n}\n\nexport function rejectedPromise(promise: MyPromise, reason: any) {\n  if (promise.state !== 'pending') return\n  promise.state = 'rejected'\n  promise.result = reason\n  promise.onRejectedCabs.forEach(cb => cb(reason))\n}\n","import {\n  isMyPromise,\n  rejectedPromise,\n  fulfilledPromise,\n  isFunction,\n  isPlanObject,\n} from \"./utils\";\n\nexport default function resolvePromise(promise, x) {\n  if (promise === x) {\n    return rejectedPromise(\n      promise,\n      new TypeError(\"Chaining cycle detected for promise\")\n    );\n  }\n  if (isMyPromise(x)) {\n    if (x.state === \"pending\") {\n      x.then(\n        (value) => {\n          resolvePromise(promise, value);\n        },\n        (reason) => {\n          rejectedPromise(promise, reason);\n        }\n      );\n      return;\n    }\n    if (x.state === \"fulfilled\") {\n      fulfilledPromise(promise, x.result);\n      return;\n    }\n    if (x.state === \"rejected\") {\n      rejectedPromise(promise, x.result);\n      return;\n    }\n    return;\n  }\n\n  if (isFunction(x) || isPlanObject(x)) {\n    let flag = false;\n    let then;\n    try {\n      then = x.then;\n    } catch (err) {\n      rejectedPromise(promise, err);\n      return;\n    }\n\n    if (isFunction(then)) {\n      try {\n        then.call(\n          x,\n          (y) => {\n            if (flag) return;\n            flag = true;\n            resolvePromise(promise, y);\n          },\n          (r) => {\n            if (flag) return;\n            flag = true;\n            rejectedPromise(promise, r);\n          }\n        );\n      } catch (err) {\n        if (flag) return;\n        flag = true;\n        rejectedPromise(promise, err);\n      }\n    } else {\n      fulfilledPromise(promise, x);\n      return\n    }\n  } else {\n    fulfilledPromise(promise, x);\n    return\n  }\n}\n","import { promiseState, ThenFn, resolver } from \"../type\";\nimport { fulfilledPromise, isFunction, rejectedPromise } from \"./utils\";\nimport resolvePromise from \"./resolvePromise\";\n\nexport default class MyPromise {\n  state: promiseState;\n  result: any;\n  onFulfilledCabs: ThenFn[];\n  onRejectedCabs: ThenFn[];\n\n  static resolve(value) {\n    return new MyPromise((resolveFn, rejectFn) => {\n      resolveFn(value);\n    });\n  }\n\n  static reject(reason) {\n    return new MyPromise((resolveFn, rejectFn) => {\n      rejectFn(reason);\n    });\n  }\n\n  constructor(fn: resolver) {\n    if (!isFunction(fn)) {\n      throw new TypeError(`Promise resolver ${ fn } is not a function`);\n    }\n    this.state = \"pending\";\n    this.result = undefined;\n    this.onFulfilledCabs = [];\n    this.onRejectedCabs = [];\n    fn(\n      (value) => {\n        resolvePromise(this, value);\n      },\n      (reason) => {\n        rejectedPromise(this, reason);\n      }\n    );\n  }\n\n  then(onFulfilled, onRejected) {\n    onFulfilled = isFunction(onFulfilled) ? onFulfilled : (value) => value;\n    onRejected = isFunction(onRejected)\n      ? onRejected\n      : (reason) => {\n        throw reason;\n      };\n    const promise2 = new MyPromise((resolve, reject) => {\n      if (this.state === \"fulfilled\") {\n        setTimeout(() => {\n          try {\n            let x = onFulfilled(this.result);\n            resolvePromise(promise2, x);\n          } catch (e) {\n            rejectedPromise(promise2, e);\n          }\n        }, 0);\n      }\n      if (this.state === \"rejected\") {\n        setTimeout(() => {\n          try {\n            let x = onRejected(this.result);\n            resolvePromise(promise2, x);\n          } catch (e) {\n            rejectedPromise(promise2, e);\n          }\n        }, 0);\n      }\n      if (this.state === \"pending\") {\n        this.onFulfilledCabs.push(() => {\n          setTimeout(() => {\n            try {\n              const x = onFulfilled(this.result);\n              resolvePromise(promise2, x);\n            } catch (err) {\n              rejectedPromise(promise2, err);\n            }\n          }, 0);\n        });\n        this.onRejectedCabs.push(() => {\n          setTimeout(() => {\n            try {\n              const x = onRejected(this.result);\n              resolvePromise(promise2, x);\n            } catch (err) {\n              rejectedPromise(promise2, err);\n            }\n          }, 0);\n        });\n      }\n    });\n    return promise2;\n  }\n}\n"],"names":[],"mappings":"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"}